<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <title>Home | Treck  Traffic</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carme&display=swap" rel="stylesheet">

</head>

<body>
    <div id="root">

        <img src="logo.png">

        <div class="View">

            <!-- <h1 class="Banner">Treck Traffic</h1> -->

            <div class="Message">

                <div class="Title">
                    <h1>Get to Know about the traffic on our roads.</h1>
                    <p>Treck traffic is an automatic google traffic data analyser and archiver!</p>
                    
                </div>

            </div>

            <div class="NavButtons">

                <a id="start">
                   Start
                </a>
                <a id="excelDb" >
                    Output Database
                </a>

                <a id="jsonDb" >
                    Database Backup
                </a>

                <a id="logs" >
                   See logs
                </a>


            </div>
            <div id="log-output">

            </div>

        </div>

    </div>


    <script>
      // https://dataarch.onrender.com
    console.log("Doing node in script tag") 
    console.log("scrip inside pug");

    const start = document.getElementById("start") 
     start.addEventListener('click',async ()=>{

       await fetch('https://dataarch.onrender.com/start');
       

     },false) 
    
  // download output file as excel
    
    const exelDb=document.getElementById("excelDb") 
        
        excelDb.addEventListener('click',async ()=>{
      try {
        const response = await fetch('https://dataarch.onrender.com/output', {
          method: 'GET',
          responseType: 'blob', // Set the response type to arraybuffer
        });

        // Set the filename for the downloaded file
        const filename = "traffic_data.xlsx"; // Set the desired filename here
        const contentDispositionHeader = response.headers.get('content-disposition');
        const matches = /filename="(.+)"/.exec(contentDispositionHeader);
        const fileDownloadName = matches === null ? filename : matches[1];

        // Create a new blob from the response data
        const blob = new Blob([response.arrayBuffer()], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        // Create a new anchor element and set its download and href attributes
        const downloadLink = document.createElement('a');
        downloadLink.download = fileDownloadName;
        downloadLink.href = window.URL.createObjectURL(blob);

        // Programmatically click the download link to start the download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      } catch (error) {
        console.error(error);
      }     
    },false);

     // download backup file as json

     const jsonDb=document.getElementById("jsonDb") 
     
     jsonDb.addEventListener('click',async ()=>{
        try {
          const response = await fetch('https://dataarch.onrender.com/backup', {
            method: 'GET',
            responseType: 'blob', // Set the response type to blob
          });

          // Set the filename for the downloaded file
          const filename = "data.json"; // Set the desired filename here
          const contentDispositionHeader = response.headers.get('content-disposition');
          const matches = /filename="(.+)"/.exec(contentDispositionHeader);
          const fileDownloadName = matches === null ? filename : matches[1];

          // Create a new blob from the response data
          const blob = await response.blob();

          // Create a new anchor element and set its download and href attributes
          const downloadLink = document.createElement('a');
          downloadLink.download = fileDownloadName;
          downloadLink.href = window.URL.createObjectURL(blob);

          // Programmatically click the download link to start the download
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        } catch (error) {
          console.error(error);
        }
    
     },false)   

     // get logs

     const streamLogsBtn = document.getElementById('logs');
    const logOutput = document.getElementById('log-output');

    // Add click event listener to the "Stream Logs" button
    streamLogsBtn.addEventListener('click',async () => {
      // Create a GET request to the "stream-logs" endpoint
     await fetch('https://dataarch.onrender.com/logs')
        .then(response => {
          // Get a ReadableStream from the response
          const stream = response.body;
          console.log("reading logs")

          // Create a TextDecoder to convert the streamed bytes to text
          const decoder = new TextDecoder();

          // Create a new ReadableStreamReader to read from the stream
          const reader = stream.getReader();

          // Define a function to read the next chunk of data from the stream
          const readChunk = () => {
            reader.read().then(({ done, value }) => {
              if (done) {
                // The stream has ended, close the reader
                reader.releaseLock();
              } else {
                // Convert the bytes to text and append to the log output
                const chunk = decoder.decode(value, { stream: true });
                logOutput.textContent += chunk;
                console.log(chunk)

                // Read the next chunk of data
                readChunk();
              }
            });
          };

          // Start reading the first chunk of data from the stream
          readChunk();
        })
        .catch(err => console.error(err));

    },false);


    const eventSource = new EventSource('/logs');

    eventSource.onmessage = (event) => {
      logOutput.innerText += event.data + '\n';
    };
    
    </script>
           
        
    </body>
    
    </html>